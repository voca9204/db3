<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB3 ì¹´ì§€ë…¸ ë°ì´í„° ë¶„ì„ ë° ë§ˆì¼€íŒ… ì „ëµ ì‹œìŠ¤í…œ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- ìºì‹œ ë¬´íš¨í™” -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .login-section {
            text-align: center;
            padding: 50px 0;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .data-table {
            font-size: 0.85rem;
        }
        
        .highlight-row {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">ğŸ° DB3 ë°ì´í„° ë¶„ì„</a>
            <div class="navbar-nav ms-auto">
                <button id="loginBtn" class="btn btn-outline-light btn-sm" style="display: none;">ë¡œê·¸ì¸</button>
                <button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div id="loginSection" class="login-section" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                            <p>DB3 ì¹´ì§€ë…¸ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                            <button id="googleSignInBtn" class="btn btn-primary btn-lg">
                                Googleë¡œ ë¡œê·¸ì¸
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboard" style="display: none;">
            <!-- ì‚¬ìš©ì ì •ë³´ -->
            <div id="userInfo" class="user-info" style="display: none;">
                <strong>ë¡œê·¸ì¸:</strong> <span id="userEmail"></span>
            </div>

            <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
            <div class="row mb-4">
                <div class="col-12">
                    <h2>ğŸš€ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
                    <div id="systemStatus" class="loading">ì‹œìŠ¤í…œ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ì£¼ìš” í†µê³„ -->
            <div class="row" id="statsRow">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPlayers">-</div>
                        <div class="stat-label">ì´ í”Œë ˆì´ì–´</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalGames">-</div>
                        <div class="stat-label">ê²Œì„ ê¸°ë¡</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPromotions">-</div>
                        <div class="stat-label">ì´ë²¤íŠ¸ ì°¸ì—¬</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTransactions">-</div>
                        <div class="stat-label">ê¸ˆìœµ ê±°ë˜</div>
                    </div>
                </div>
            </div>

            <!-- ë°ì´í„° ì¡°íšŒ ì„¹ì…˜ -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h4>ğŸ“Š ë°ì´í„° ì¡°íšŒ</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <button id="loadGameActivityBtn" class="btn btn-primary w-100 mb-2">
                                    ê²Œì„ í™œë™ ë¶„ì„
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button id="loadDormantBtn" class="btn btn-warning w-100 mb-2">
                                    íœ´ë©´ ì‚¬ìš©ì ë¶„ì„
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button id="loadEventsBtn" class="btn btn-info w-100 mb-2">
                                    ì´ë²¤íŠ¸ ì°¸ì—¬ ë¶„ì„
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°ì´í„° í‘œì‹œ ì˜ì—­ -->
            <div class="row">
                <div class="col-12">
                    <div id="dataContainer" class="chart-container" style="display: none;">
                        <h4 id="dataTitle">ë°ì´í„°</h4>
                        <div id="dataContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyD2RY02pN2RrhT8Qt2hTSEilRqV4JAbCR0",
            authDomain: "db888-67827.firebaseapp.com",
            projectId: "db888-67827",
            storageBucket: "db888-67827.firebasestorage.app",
            messagingSenderId: "888497598316",
            appId: "1:888497598316:web:b2cb26b0a825e11a658d49"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM ìš”ì†Œ
        const loginSection = document.getElementById('loginSection');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');

        // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
        auth.onAuthStateChanged((user) => {
            if (user && user.email === 'sandscasino8888@gmail.com') {
                // ë¡œê·¸ì¸ ì„±ê³µ
                showDashboard(user);
            } else {
                // ë¡œê·¸ì¸ ì•ˆë¨ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ
                showLogin();
            }
        });

        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLogin() {
            loginSection.style.display = 'block';
            dashboard.style.display = 'none';
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            userInfo.style.display = 'none';
        }

        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        function showDashboard(user) {
            loginSection.style.display = 'none';
            dashboard.style.display = 'block';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            userInfo.style.display = 'block';
            userEmail.textContent = user.email;
            
            // ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ
            loadSystemStatus();
        }

        // Google ë¡œê·¸ì¸
        googleSignInBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showError('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });

        // ë¡œê·¸ì•„ì›ƒ
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // API í˜¸ì¶œ í—¬í¼
        async function apiCall(endpoint, requireAuth = true) {
            // Firebase Functions URL ì‚¬ìš©
            const functionsUrl = 'https://us-central1-db888-67827.cloudfunctions.net';
            const url = `${functionsUrl}/${endpoint}`;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (requireAuth && auth.currentUser) {
                const token = await auth.currentUser.getIdToken();
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url, { headers });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ
        async function loadSystemStatus() {
            try {
                const data = await apiCall('getSystemStatus', false);
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="success">
                        <strong>âœ… ì‹œìŠ¤í…œ ì •ìƒ ë™ì‘</strong><br>
                        ë²„ì „: ${data.version} | 
                        ë°ì´í„°ë² ì´ìŠ¤: ${data.database.status} | 
                        ì‹œê°„: ${new Date(data.timestamp).toLocaleString('ko-KR')}
                    </div>
                `;
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                const stats = {};
                data.statistics.forEach(stat => {
                    stats[stat.table_name] = stat.record_count;
                });
                
                document.getElementById('totalPlayers').textContent = stats.players?.toLocaleString() || '-';
                document.getElementById('totalGames').textContent = stats.game_scores?.toLocaleString() || '-';
                document.getElementById('totalPromotions').textContent = stats.promotion_players?.toLocaleString() || '-';
                document.getElementById('totalTransactions').textContent = stats.money_flows?.toLocaleString() || '-';
                
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('systemStatus').innerHTML = `
                    <div class="error">
                        <strong>âŒ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // ê²Œì„ í™œë™ ë¶„ì„ ì¡°íšŒ
        document.getElementById('loadGameActivityBtn').addEventListener('click', async () => {
            await loadData('getUserGameActivity', 'ê²Œì„ í™œë™ ë¶„ì„', true);
        });

        // íœ´ë©´ ì‚¬ìš©ì ì¡°íšŒ
        document.getElementById('loadDormantBtn').addEventListener('click', async () => {
            await loadData('getDormantUsers', 'íœ´ë©´ ì‚¬ìš©ì ë¶„ì„', true);
        });

        // ì´ë²¤íŠ¸ ì°¸ì—¬ ë¶„ì„ ì¡°íšŒ
        document.getElementById('loadEventsBtn').addEventListener('click', async () => {
            await loadData('getEventParticipationAnalysis', 'ì´ë²¤íŠ¸ ì°¸ì—¬ ë¶„ì„', true);
        });

        // ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
        async function loadData(endpoint, title, requireAuth = true) {
            const container = document.getElementById('dataContainer');
            const titleEl = document.getElementById('dataTitle');
            const contentEl = document.getElementById('dataContent');
            
            try {
                titleEl.textContent = title;
                contentEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                container.style.display = 'block';
                
                const data = await apiCall(endpoint, requireAuth);
                
                if (data.status === 'success' && data.data) {
                    displayTable(data.data, contentEl);
                } else {
                    contentEl.innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
            } catch (error) {
                console.error(`${endpoint} ì˜¤ë¥˜:`, error);
                contentEl.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // í…Œì´ë¸” í‘œì‹œ
        function displayTable(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const headers = Object.keys(data[0]);
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped data-table">
                        <thead class="table-dark">
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((row, index) => {
                const isHighlight = row.totalNetBet >= 10000000; // ì²œë§Œì›ëŒ€ í•˜ì´ë¼ì´íŠ¸
                html += `<tr ${isHighlight ? 'class="highlight-row"' : ''}>`;
                headers.forEach(header => {
                    let value = row[header];
                    if (typeof value === 'number' && value > 1000) {
                        value = value.toLocaleString();
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <small class="text-muted">ì´ ${data.length}ê°œ ë ˆì½”ë“œ</small>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ì¸ì¦ ì²´í¬
        document.addEventListener('DOMContentLoaded', async () => {
            // ì¸ì¦ ì²´í¬ (í˜ì´ì§€ ë³´í˜¸)
            try {
                await protectPage();
                console.log("âœ… ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì¸ì¦ ì™„ë£Œ");
            } catch (error) {
                console.log("ğŸš« ì¸ì¦ ì‹¤íŒ¨:", error.message);
                return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë‚˜ë¨¸ì§€ ì´ˆê¸°í™” ì¤‘ë‹¨
            }
            
            console.log('DB3 ì¹´ì§€ë…¸ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ v1.0.0 ë¡œë“œë¨');
        });
    </script>
    
    <!-- Firebase SDK (compat ë°©ì‹) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- ì¸ì¦ ì‹œìŠ¤í…œ -->
    <script src="/js/auth.js"></script>
    
    <!-- ë³´ì•ˆ ì •ì±… ì‹œìŠ¤í…œ -->
    <script src="/js/security-policy.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ë³´ì•ˆ ì •ì±… ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ ì¸ì¦ ë¡œì§ ì™„ë£Œ í›„ ë³´ì•ˆ ì •ì±… ì´ˆê¸°í™”
            setTimeout(() => {
                initializeSecurityPolicy();
            }, 1000);
        });
    </script>
</body>
</html>
