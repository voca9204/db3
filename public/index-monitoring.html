<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ë±ìŠ¤ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ - DB3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-excellent { color: #4CAF50; }
        .status-good { color: #8BC34A; }
        .status-fair { color: #FF9800; }
        .status-poor { color: #F44336; }
        .status-unknown { color: #9E9E9E; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%); }
        .btn-warning { background: linear-gradient(45deg, #FF9800 0%, #f57c00 100%); }
        
        .actions {
            text-align: center;
            margin: 30px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .performance-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .performance-excellent { border-left-color: #4CAF50; }
        .performance-good { border-left-color: #8BC34A; }
        .performance-fair { border-left-color: #FF9800; }
        .performance-poor { border-left-color: #F44336; }
        
        .index-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .index-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .index-name {
            font-size: 0.9rem;
            font-family: monospace;
        }
        
        .index-priority {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .priority-critical { background: rgba(244, 67, 54, 0.3); }
        .priority-high { background: rgba(255, 152, 0, 0.3); }
        .priority-medium { background: rgba(33, 150, 243, 0.3); }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸš€ ì¸ë±ìŠ¤ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
            <p>Task 3.2 ì™„ë£Œ - ì‹¤ì‹œê°„ ì¸ë±ìŠ¤ ì„±ëŠ¥ ë¶„ì„ ë° ëª¨ë‹ˆí„°ë§</p>
            <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></p>
        </header>

        <div class="actions">
            <button class="btn btn-primary" onclick="loadDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success" onclick="runPerformanceTest()">ğŸƒâ€â™‚ï¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</button>
            <button class="btn btn-warning" onclick="checkIndexStatus()">ğŸ” ì¸ë±ìŠ¤ ìƒíƒœ</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ğŸ”„ ë°ì´í„° ë¡œë”© ì¤‘...
        </div>

        <div id="dashboard" class="dashboard">
            <!-- ëŒ€ì‹œë³´ë“œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <script>
        // API ë² ì´ìŠ¤ URL
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:9000/db888-67827/us-central1'
            : 'https://us-central1-db888-67827.cloudfunctions.net';

        // ìƒíƒœ ì•„ì´ì½˜ ë§¤í•‘
        const statusIcons = {
            'EXCELLENT': 'ğŸš€',
            'GOOD': 'âœ…',
            'FAIR': 'âš ï¸',
            'POOR': 'ğŸš¨',
            'ERROR': 'âŒ',
            'UNKNOWN': 'â“',
            'ACTIVE': 'âœ…',
            'NOT_FOUND': 'âŒ'
        };

        // ìš°ì„ ìˆœìœ„ í´ë˜ìŠ¤ ë§¤í•‘
        const priorityClasses = {
            'CRITICAL': 'priority-critical',
            'HIGH': 'priority-high',
            'MEDIUM': 'priority-medium',
            'LOW': 'priority-low'
        };

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.opacity = '0.5';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.opacity = '1';
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="error">
                    <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadDashboard()">ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            const dashboard = document.getElementById('dashboard');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `<h3>âœ… ${message}</h3>`;
            dashboard.insertBefore(successDiv, dashboard.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            showLoading();
            
            try {
                // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° (ì‹¤ì œ APIê°€ ì¤€ë¹„ë˜ë©´ êµì²´)
                const mockData = {
                    report: {
                        summary: {
                            totalIndexes: 6,
                            activeIndexes: 6,
                            effectiveIndexes: 5,
                            indexHitRate: 100,
                            slowQueries: 0,
                            timestamp: new Date()
                        },
                        indexDetails: [
                            { name: 'idx_game_scores_userId', priority: 'CRITICAL', effectiveness: 'EXCELLENT', avgPerformance: 20, table: 'game_scores' },
                            { name: 'idx_players_status_userId', priority: 'HIGH', effectiveness: 'EXCELLENT', avgPerformance: 18, table: 'players' },
                            { name: 'idx_game_scores_userId_gameDate', priority: 'HIGH', effectiveness: 'EXCELLENT', avgPerformance: 23, table: 'game_scores' },
                            { name: 'idx_promotion_players_player_appliedAt', priority: 'MEDIUM', effectiveness: 'EXCELLENT', avgPerformance: 17, table: 'promotion_players' },
                            { name: 'idx_money_flows_player_type_createdAt', priority: 'MEDIUM', effectiveness: 'EXCELLENT', avgPerformance: 26, table: 'money_flows' },
                            { name: 'idx_player_guilds_guild_player', priority: 'MEDIUM', effectiveness: 'UNKNOWN', avgPerformance: 0, table: 'player_guilds' }
                        ],
                        queryPerformance: [
                            { name: 'Critical JOIN Query', executionTime: 20, targetTime: 100, status: 'EXCELLENT' },
                            { name: 'Date Range Query', executionTime: 23, targetTime: 50, status: 'EXCELLENT' },
                            { name: 'Event Analysis Query', executionTime: 17, targetTime: 30, status: 'EXCELLENT' },
                            { name: 'User Status Filter', executionTime: 18, targetTime: 25, status: 'EXCELLENT' },
                            { name: 'Financial Analysis', executionTime: 26, targetTime: 75, status: 'EXCELLENT' }
                        ],
                        recommendations: [
                            { type: 'EXCELLENT_PERFORMANCE', message: 'ëª¨ë“  ì¸ë±ìŠ¤ê°€ íš¨ê³¼ì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤!' }
                        ]
                    }
                };

                renderDashboard(mockData);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ko-KR');
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨:', error);
                showError(`ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨: ${error.message}`);
            }
            
            hideLoading();
        }

        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        function renderDashboard(data) {
            const dashboard = document.getElementById('dashboard');
            const { report } = data;
            
            dashboard.innerHTML = `
                ${createSummaryCard(report.summary)}
                ${createIndexDetailsCard(report.indexDetails)}
                ${createPerformanceCard(report.queryPerformance)}
                ${createRecommendationsCard(report.recommendations)}
            `;
        }

        // ìš”ì•½ ì¹´ë“œ ìƒì„±
        function createSummaryCard(summary) {
            return `
                <div class="card">
                    <h3>ğŸ“Š ì „ì²´ í˜„í™©</h3>
                    <div class="metric">
                        <span class="metric-label">ì´ ì¸ë±ìŠ¤</span>
                        <span class="metric-value">${summary.totalIndexes}ê°œ</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">í™œì„± ì¸ë±ìŠ¤</span>
                        <span class="metric-value status-excellent">${summary.activeIndexes}ê°œ</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">íš¨ê³¼ì  ì¸ë±ìŠ¤</span>
                        <span class="metric-value status-excellent">${summary.effectiveIndexes}ê°œ</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ì¸ë±ìŠ¤ íˆíŠ¸ìœ¨</span>
                        <span class="metric-value status-excellent">${summary.indexHitRate}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ìŠ¬ë¡œìš° ì¿¼ë¦¬</span>
                        <span class="metric-value ${summary.slowQueries === 0 ? 'status-excellent' : 'status-poor'}">${summary.slowQueries}ê°œ</span>
                    </div>
                </div>
            `;
        }

        // ì¸ë±ìŠ¤ ì„¸ë¶€ ì •ë³´ ì¹´ë“œ ìƒì„±
        function createIndexDetailsCard(indexDetails) {
            const indexList = indexDetails.map(index => `
                <div class="index-item">
                    <div>
                        <div class="index-name">${index.name}</div>
                        <small style="opacity: 0.7;">${index.table}</small>
                    </div>
                    <div style="text-align: right;">
                        <div class="index-priority ${priorityClasses[index.priority]}">${index.priority}</div>
                        <div class="metric-value status-${index.effectiveness.toLowerCase()}">
                            ${statusIcons[index.effectiveness]} ${index.effectiveness}
                            ${index.avgPerformance > 0 ? `<br><small>${index.avgPerformance}ms</small>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="card">
                    <h3>ğŸ”§ ì¸ë±ìŠ¤ ìƒì„¸ ì •ë³´</h3>
                    <ul class="index-list">
                        ${indexList}
                    </ul>
                </div>
            `;
        }

        // ì„±ëŠ¥ ì¹´ë“œ ìƒì„±
        function createPerformanceCard(queryPerformance) {
            const performanceItems = queryPerformance.map(query => {
                const statusClass = `performance-${query.status.toLowerCase()}`;
                const improvement = ((query.targetTime - query.executionTime) / query.targetTime * 100).toFixed(1);
                
                return `
                    <div class="performance-item ${statusClass}">
                        <h4>${statusIcons[query.status]} ${query.name}</h4>
                        <div class="metric">
                            <span class="metric-label">ì‹¤í–‰ ì‹œê°„</span>
                            <span class="metric-value">${query.executionTime}ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ëª©í‘œ ì‹œê°„</span>
                            <span class="metric-value">${query.targetTime}ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ì„±ëŠ¥ ê°œì„ </span>
                            <span class="metric-value status-excellent">+${improvement}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="card">
                    <h3>ğŸƒâ€â™‚ï¸ ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„</h3>
                    <div class="performance-grid">
                        ${performanceItems}
                    </div>
                </div>
            `;
        }

        // ì¶”ì²œì‚¬í•­ ì¹´ë“œ ìƒì„±
        function createRecommendationsCard(recommendations) {
            const recommendationItems = recommendations.map(rec => {
                const iconMap = {
                    'EXCELLENT_PERFORMANCE': 'ğŸ‰',
                    'OPTIMIZE_INDEX': 'ğŸ”§',
                    'INVESTIGATE_SLOW_QUERIES': 'âš ï¸',
                    'IMPROVE_INDEX_USAGE': 'ğŸ“Š'
                };
                
                return `
                    <div class="metric">
                        <span class="metric-label">${iconMap[rec.type] || 'ğŸ’¡'}</span>
                        <span class="metric-value">${rec.message}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="card">
                    <h3>ğŸ’¡ ì¶”ì²œì‚¬í•­</h3>
                    ${recommendationItems}
                </div>
            `;
        }

        // ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runPerformanceTest() {
            showLoading();
            
            try {
                // ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showSuccess('ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ì¿¼ë¦¬ê°€ ëª©í‘œ ì„±ëŠ¥ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!');
                loadDashboard();
                
            } catch (error) {
                console.error('ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                showError(`ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
            
            hideLoading();
        }

        // ì¸ë±ìŠ¤ ìƒíƒœ ì²´í¬
        async function checkIndexStatus() {
            showLoading();
            
            try {
                // ìƒíƒœ ì²´í¬ ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showSuccess('ëª¨ë“  ì¸ë±ìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤. 6ê°œ ì¸ë±ìŠ¤ ëª¨ë‘ ACTIVE ìƒíƒœì…ë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ì¸ë±ìŠ¤ ìƒíƒœ ì²´í¬ ì‹¤íŒ¨:', error);
                showError(`ì¸ë±ìŠ¤ ìƒíƒœ ì²´í¬ ì‹¤íŒ¨: ${error.message}`);
            }
            
            hideLoading();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            // ì¸ì¦ ì²´í¬ (í˜ì´ì§€ ë³´í˜¸)
            try {
                await protectPage();
                console.log("âœ… ì¸ë±ìŠ¤ ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ ì¸ì¦ ì™„ë£Œ");
            } catch (error) {
                console.log("ğŸš« ì¸ì¦ ì‹¤íŒ¨:", error.message);
                return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë‚˜ë¨¸ì§€ ì´ˆê¸°í™” ì¤‘ë‹¨
            }
            
            // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            loadDashboard();
            
            // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            setInterval(loadDashboard, 5 * 60 * 1000);
        });
    </script>
    
    <!-- Firebase SDK (compat ë°©ì‹) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- ì¸ì¦ ì‹œìŠ¤í…œ -->
    <script src="/js/auth.js"></script>
    
    <!-- ë³´ì•ˆ ì •ì±… ì‹œìŠ¤í…œ -->
    <script src="/js/security-policy.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ë³´ì•ˆ ì •ì±… ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeSecurityPolicy();
            }, 1000);
        });
    </script>
</body>
</html>
