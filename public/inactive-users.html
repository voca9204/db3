<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB3 - ê°€ì… í›„ ë¯¸í™œì„± ì‚¬ìš©ì ë¶„ì„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            border: none;
            padding: 1.5rem;
        }
        
        .period-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .period-1month {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .period-1-6months {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }
        
        .period-7-12months {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: white;
        }
        
        .rep-id {
            background: linear-gradient(135deg, #ab47bc, #8e24aa);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
            box-shadow: 0 2px 8px rgba(171, 71, 188, 0.3);
        }
        
        .user-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .user-card.period-1month {
            border-left-color: #ff6b6b;
        }
        
        .user-card.period-1-6months {
            border-left-color: #ffa726;
        }
        
        .user-card.period-7-12months {
            border-left-color: #42a5f5;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }
        
        .marketing-insight {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .performance-badge {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
        }

        .group-card {
            background: rgba(171, 71, 188, 0.1);
            border: 2px solid rgba(171, 71, 188, 0.3);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="mb-0"><i class="fas fa-user-slash me-2"></i>ê°€ì… í›„ ë¯¸í™œì„± ì‚¬ìš©ì ë¶„ì„</h1>
                                <p class="mb-0 mt-2 opacity-75">ìµœê·¼ 1ë…„ ì´ë‚´ ê°€ì… + ê²Œì„ ì‹¤ì  ì—†ëŠ” ì‚¬ìš©ì í˜„í™©</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="downloadCSV()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none; border-radius: 25px; padding: 0.75rem 2rem; color: white; font-weight: 600;">
                                    <i class="fas fa-download me-2"></i>CSV ë‹¤ìš´ë¡œë“œ
                                </button>
                                <button class="btn btn-refresh" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-2"></i>ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Summary Stats Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalUsers">0</div>
                        <div>ì´ ë¯¸í™œì„± ì‚¬ìš©ì</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                        <div class="stats-number" id="monthUsers">0</div>
                        <div>1ë‹¬ ì´ë‚´ ê°€ì…</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <div class="stats-number" id="sixMonthUsers">0</div>
                        <div>1-6ê°œì›” ê°€ì…</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div class="stats-number" id="yearUsers">0</div>
                        <div>7-12ê°œì›” ê°€ì…</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>ê°€ì… ê¸°ê°„ë³„ ë¶„í¬</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="periodChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ëŒ€í‘œID ë³´ìœ  í˜„í™©</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="repIdChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance & Marketing Insights -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="marketing-insight">
                        <h5><i class="fas fa-lightbulb me-2"></i>ë§ˆì¼€íŒ… ì¸ì‚¬ì´íŠ¸</h5>
                        <div id="marketingInsights"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>ì„±ëŠ¥ ì •ë³´</h5>
                        </div>
                        <div class="card-body">
                            <div class="performance-badge">
                                <i class="fas fa-clock me-1"></i>ì¿¼ë¦¬ ì‹¤í–‰ì‹œê°„: <span id="queryTime">-</span>ms
                            </div>
                            <div class="performance-badge ms-2">
                                <i class="fas fa-database me-1"></i>ê²°ê³¼ ìˆ˜: <span id="resultCount">-</span>ê°œ
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Lists by Period -->
            <div class="row">
                <!-- 1ë‹¬ ì´ë‚´ -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="period-badge period-1month">ğŸŸ¢ 1ë‹¬ ì´ë‚´</span>
                                <span class="badge bg-secondary ms-2" id="count1Month">0ëª…</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="users1Month"></div>
                        </div>
                    </div>
                </div>

                <!-- 1-6ê°œì›” -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="period-badge period-1-6months">ğŸŸ¡ 1-6ê°œì›”</span>
                                <span class="badge bg-secondary ms-2" id="count1To6Months">0ëª…</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="users1To6Months"></div>
                        </div>
                    </div>
                </div>

                <!-- 7-12ê°œì›” -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="period-badge period-7-12months">ğŸ”´ 7-12ê°œì›”</span>
                                <span class="badge bg-secondary ms-2" id="count7To12Months">0ëª…</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="users7To12Months"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Representative ID Groups -->
            <div class="row" id="repIdGroups" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-link me-2"></i>ëŒ€í‘œIDë³„ ê·¸ë£¹ í˜„í™©</h5>
                        </div>
                        <div class="card-body">
                            <div id="groupedUsers"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let periodChart, repIdChart;
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("âœ… ë¯¸í™œì„± ì‚¬ìš©ì ë¶„ì„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");
            
            // Firebase ì´ˆê¸°í™” (ì¸ì¦ í‘œì‹œìš©)
            try {
                await initializeFirebase();
                await checkAuthStatus();
                showAuthStatus(true, getCurrentUserEmail());
                console.log("âœ… ì¸ì¦ ì™„ë£Œ");
            } catch (error) {
                console.log("âš ï¸ ì¸ì¦ ì‹¤íŒ¨í•˜ì§€ë§Œ ê³µê°œ API ì‚¬ìš©:", error.message);
                showAuthStatus(false);
            }
            
            // ë°ì´í„° ë¡œë“œ (ì¸ì¦ê³¼ ê´€ê³„ì—†ì´ ì‹¤í–‰)
            loadData();
        });

        async function loadData() {
            showLoading();
            
            try {
                // ë¡œì»¬ ê°œë°œí™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ë¶„
                const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
                const apiUrl = isLocal 
                    ? 'http://127.0.0.1:5001/db888-67827/us-central1/getInactiveNewUsersAnalysis'
                    : 'https://us-central1-db888-67827.cloudfunctions.net/getInactiveNewUsersAnalysis?v=' + Date.now();
                
                console.log('Loading data from:', apiUrl);
                
                // ê³µê°œ APIì´ë¯€ë¡œ ì¸ì¦ í—¤ë” ë¶ˆí•„ìš”
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayData(result);
                } else {
                    showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            hideLoading();
            document.getElementById('mainContent').innerHTML = `
                <div class="alert alert-danger text-center">
                    <h4>ì˜¤ë¥˜ ë°œìƒ</h4>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadData()">ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
            document.getElementById('mainContent').style.display = 'block';
        }

        function displayData(result) {
            const { data, analysis, performance, groupedByRepId } = result;
            
            // Update summary stats
            document.getElementById('totalUsers').textContent = analysis.total;
            document.getElementById('monthUsers').textContent = analysis.byPeriod['1ë‹¬ì´ë‚´'];
            document.getElementById('sixMonthUsers').textContent = analysis.byPeriod['1-6ê°œì›”'];
            document.getElementById('yearUsers').textContent = analysis.byPeriod['7-12ê°œì›”'];
            
            // Update performance info
            document.getElementById('queryTime').textContent = performance.queryTime;
            document.getElementById('resultCount').textContent = performance.resultCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ko-KR');
            
            // Update period counts
            document.getElementById('count1Month').textContent = analysis.byPeriod['1ë‹¬ì´ë‚´'] + 'ëª…';
            document.getElementById('count1To6Months').textContent = analysis.byPeriod['1-6ê°œì›”'] + 'ëª…';
            document.getElementById('count7To12Months').textContent = analysis.byPeriod['7-12ê°œì›”'] + 'ëª…';
            
            // Display user lists
            displayUsersByPeriod(data, '1ë‹¬ì´ë‚´', 'users1Month');
            displayUsersByPeriod(data, '1-6ê°œì›”', 'users1To6Months');
            displayUsersByPeriod(data, '7-12ê°œì›”', 'users7To12Months');
            
            // Display grouped users if there are any
            if (groupedByRepId && Object.keys(groupedByRepId).length > 0) {
                displayGroupedUsers(groupedByRepId);
                document.getElementById('repIdGroups').style.display = 'block';
            }
            
            // Display marketing insights
            displayMarketingInsights(analysis);
            
            // Create charts
            createPeriodChart(analysis);
            createRepIdChart(analysis);
            
            hideLoading();
        }

        function displayUsersByPeriod(data, period, containerId) {
            const users = data.filter(user => user.join_period === period);
            const container = document.getElementById(containerId);
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">í•´ë‹¹ ê¸°ê°„ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const periodClass = period === '1ë‹¬ì´ë‚´' ? 'period-1month' : 
                               period === '1-6ê°œì›”' ? 'period-1-6months' : 'period-7-12months';
            
            container.innerHTML = users.map((user, index) => {
                const joinDate = new Date(user.join_date).toLocaleDateString('ko-KR');
                const repId = user.representative_userId ? 
                    `<div class="small text-info mt-1">
                        <i class="fas fa-link"></i> ëŒ€í‘œID: ${user.representative_userId.substring(0, 12)}...
                     </div>` : 
                    `<div class="small text-muted mt-1">
                        <i class="fas fa-user"></i> ë‹¨ë… ê³„ì •
                     </div>`;
                
                return `
                    <div class="user-card ${periodClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-secondary me-2">${index + 1}</span>
                                    <strong class="text-primary">${user.userId}</strong>
                                </div>
                                ${repId}
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">${joinDate}</div>
                                <div class="small text-muted">${user.days_since_join}ì¼ ì „ ê°€ì…</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayGroupedUsers(groupedByRepId) {
            const container = document.getElementById('groupedUsers');
            
            container.innerHTML = Object.entries(groupedByRepId).map(([repId, users]) => {
                const userList = users.map((user, index) => {
                    const joinDate = new Date(user.join_date).toLocaleDateString('ko-KR');
                    const periodBadgeClass = user.join_period === '1ë‹¬ì´ë‚´' ? 'bg-danger' : 
                                           user.join_period === '1-6ê°œì›”' ? 'bg-warning' : 'bg-info';
                    
                    return `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <span class="me-2">${index + 1}.</span>
                                <div>
                                    <div class="fw-bold text-primary">${user.userId}</div>
                                    <small class="text-muted">ê°€ì…: ${joinDate} (${user.days_since_join}ì¼ ì „)</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge ${periodBadgeClass}">${user.join_period}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // ëŒ€í‘œIDì™€ ì—°ê²°ëœ ëª¨ë“  ì‚¬ìš©ì IDë¥¼ í—¤ë”ì— ìš”ì•½ í‘œì‹œ
                const userIdSummary = users.map(u => u.userId).join(', ');
                const shortSummary = userIdSummary.length > 50 ? 
                    userIdSummary.substring(0, 47) + '...' : userIdSummary;
                
                return `
                    <div class="group-card">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <span class="rep-id">ğŸ”— ëŒ€í‘œID: ${repId.substring(0, 12)}...</span>
                                </h6>
                                <span class="badge bg-primary fs-6">${users.length}ê°œ ê³„ì •</span>
                            </div>
                            <div class="small text-muted">
                                <strong>ì—°ê²°ëœ ê³„ì •:</strong> ${shortSummary}
                            </div>
                        </div>
                        <div class="user-details">
                            <h6 class="text-secondary mb-2">ğŸ“‹ ìƒì„¸ ì •ë³´</h6>
                            ${userList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayMarketingInsights(analysis) {
            const container = document.getElementById('marketingInsights');
            const insights = [];
            
            if (analysis.byPeriod['1ë‹¬ì´ë‚´'] > 0) {
                insights.push(`ğŸ¯ <strong>1ë‹¬ ì´ë‚´ ê°€ì…ì (${analysis.byPeriod['1ë‹¬ì´ë‚´']}ëª…)</strong>: ì˜¨ë³´ë”© ê°œì„  ë° ì¦‰ì‹œ í™œì„±í™” ìº í˜ì¸ í•„ìš”`);
            }
            
            if (analysis.byPeriod['1-6ê°œì›”'] > 0) {
                insights.push(`ğŸª <strong>1-6ê°œì›” ê°€ì…ì (${analysis.byPeriod['1-6ê°œì›”']}ëª…)</strong>: ì¬í™œì„±í™” ì´ë²¤íŠ¸ ë° ë§ì¶¤ í”„ë¡œëª¨ì…˜ ê¶Œì¥`);
            }
            
            if (analysis.byPeriod['7-12ê°œì›”'] > 0) {
                insights.push(`ğŸ’ª <strong>7-12ê°œì›” ê°€ì…ì (${analysis.byPeriod['7-12ê°œì›”']}ëª…)</strong>: ê°•ë ¥í•œ ë³µê·€ ì¸ì„¼í‹°ë¸Œ ë˜ëŠ” ê³„ì • ì •ë¦¬ ê²€í† `);
            }
            
            if (analysis.withRepresentativeId > 0) {
                insights.push(`ğŸ”— <strong>ëŒ€í‘œID ë³´ìœ ì (${analysis.withRepresentativeId}ëª…)</strong>: ë‹¤ì¤‘ ê³„ì • ê´€ë¦¬ ì „ëµ í•„ìš”`);
            }
            
            container.innerHTML = insights.map(insight => `<div class="mb-2">${insight}</div>`).join('');
        }

        function createPeriodChart(analysis) {
            const ctx = document.getElementById('periodChart').getContext('2d');
            
            if (periodChart) {
                periodChart.destroy();
            }
            
            periodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['1ë‹¬ ì´ë‚´', '1-6ê°œì›”', '7-12ê°œì›”'],
                    datasets: [{
                        data: [
                            analysis.byPeriod['1ë‹¬ì´ë‚´'],
                            analysis.byPeriod['1-6ê°œì›”'],
                            analysis.byPeriod['7-12ê°œì›”']
                        ],
                        backgroundColor: [
                            '#ff6b6b',
                            '#ffa726',
                            '#42a5f5'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createRepIdChart(analysis) {
            const ctx = document.getElementById('repIdChart').getContext('2d');
            
            if (repIdChart) {
                repIdChart.destroy();
            }
            
            repIdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ëŒ€í‘œID ë³´ìœ ', 'ëŒ€í‘œID ë¯¸ë³´ìœ '],
                    datasets: [{
                        label: 'ì‚¬ìš©ì ìˆ˜',
                        data: [analysis.withRepresentativeId, analysis.withoutRepresentativeId],
                        backgroundColor: [
                            '#ab47bc',
                            '#78909c'
                        ],
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function refreshData() {
            loadData();
        }

        async function downloadCSV() {
            try {
                // ë¡œì»¬ ê°œë°œí™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ë¶„
                const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
                const apiUrl = isLocal 
                    ? 'http://127.0.0.1:5001/db888-67827/us-central1/downloadInactiveUsersCSV'
                    : 'https://us-central1-db888-67827.cloudfunctions.net/downloadInactiveUsersCSV?v=' + Date.now();
                
                console.log('Downloading CSV from:', apiUrl);
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const downloadBtn = event.target;
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ë‹¤ìš´ë¡œë“œ ì¤‘...';
                downloadBtn.disabled = true;
                
                // ê³µê°œ APIì´ë¯€ë¡œ ì¸ì¦ í—¤ë” ë¶ˆí•„ìš”
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Blobìœ¼ë¡œ ì‘ë‹µ ë°›ê¸°
                const blob = await response.blob();
                
                // íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸° (Content-Disposition í—¤ë”ì—ì„œ)
                const contentDisposition = response.headers.get('Content-Disposition');
                let fileName = 'inactive_users.csv';
                if (contentDisposition) {
                    const fileNameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (fileNameMatch) {
                        fileName = fileNameMatch[1];
                    }
                }
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                alert(`CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`);
                
            } catch (error) {
                console.error('CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                const downloadBtn = document.querySelector('button[onclick="downloadCSV()"]');
                if (downloadBtn) {
                    downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i>CSV ë‹¤ìš´ë¡œë“œ';
                    downloadBtn.disabled = false;
                }
            }
        }
    </script>
    
    <!-- Firebase SDK (compat ë°©ì‹) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- ì¸ì¦ ì‹œìŠ¤í…œ -->
    <script src="/js/auth.js"></script>
    
    <!-- ë³´ì•ˆ ì •ì±… ì‹œìŠ¤í…œ -->
    <script src="/js/security-policy.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ë³´ì•ˆ ì •ì±… ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeSecurityPolicy();
            }, 1000);
        });
    </script>
</body>
</html>
